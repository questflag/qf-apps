@page "/login"
@using QuestFlag.Passport.UserClient
@inject PassportUserClient PassportClient
@inject NavigationManager Nav
@inject IJSRuntime JS

<PageTitle>Sign In — @(_resolvedTenant?.Name ?? "QuestFlag")</PageTitle>

<div class="sso-container">
    <div class="sso-card">
        <!-- Brand / Tenant Header -->
        <div class="sso-header">
            <div class="brand-logo">QF</div>
            @if (_resolvedTenant != null)
            {
                <h1 class="tenant-name">@_resolvedTenant.Name</h1>
                <p class="sign-in-subtitle">Sign in to your account</p>
            }
            else
            {
                <h1 class="tenant-name">QuestFlag</h1>
                <p class="sign-in-subtitle">Sign in to continue</p>
            }
        </div>

        @if (_error != null)
        {
            <div class="error-banner">@_error</div>
        }

        <form @onsubmit="HandleLogin">
            <!-- Tenant selector (only shown when not auto-resolved from domain) -->
            @if (_resolvedTenant == null)
            {
                <div class="form-group">
                    <label>Organization</label>
                    <select @bind="_tenantSlug" disabled="@(_loadingTenants || _tenants == null)">
                        <option value="">— Select your organization —</option>
                        @foreach (var t in _tenants ?? [])
                        {
                            <option value="@t.Slug">@t.Name</option>
                        }
                    </select>
                </div>
            }

            <div class="form-group">
                <label>Username</label>
                <input @bind="_username" type="text" placeholder="username" autocomplete="username" required />
            </div>

            <div class="form-group">
                <label>Password</label>
                <input @bind="_password" type="password" placeholder="••••••••" autocomplete="current-password" required />
            </div>

            <button type="submit" class="btn-primary" disabled="@_isSubmitting">
                @(_isSubmitting ? "Signing in…" : "Continue")
            </button>
        </form>

        <div class="sso-footer">
            <a href="/forgot-password">Forgot password?</a>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromQuery] public string? ReturnUrl { get; set; }
    [SupplyParameterFromQuery] public string? ClientId  { get; set; }

    private IReadOnlyList<TenantDto>? _tenants;
    private ResolvedTenantDto? _resolvedTenant;
    private bool _loadingTenants = true;
    private string _tenantSlug = "";
    private string _username   = "";
    private string _password   = "";
    private string? _error;
    private bool _isSubmitting;

    protected override async Task OnInitializedAsync()
    {
        // 1. Try to resolve tenant from the Host header (server-side, via cascading parameter or JS interop)
        try
        {
            var host = await JS.InvokeAsync<string>("eval", "window.location.host");
            _resolvedTenant = await PassportClient.ResolveTenantByDomainAsync(host);
            if (_resolvedTenant != null)
                _tenantSlug = _resolvedTenant.Slug;
        }
        catch { /* ignore — fallback to dropdown */ }

        // 2. Load all tenants for dropdown (if no auto-resolved tenant)
        if (_resolvedTenant == null)
        {
            try
            {
                _tenants = await PassportClient.GetTenantsAsync();
                if (_tenants.Count == 1)
                {
                    _tenantSlug = _tenants[0].Slug;
                }
            }
            catch { _error = "Could not load organizations. The auth service may be offline."; }
        }

        _loadingTenants = false;
    }

    private async Task HandleLogin()
    {
        if (string.IsNullOrWhiteSpace(_tenantSlug)) { _error = "Please select an organization."; return; }

        _error = null;
        _isSubmitting = true;

        try
        {
            // Build the authorize URL — redirect to Passport.Services /connect/authorize
            // The Passport.Services will handle PKCE code challenge verification.
            // For the SSO WebApp's own session we'd use form-based login + server cookie here.
            // For now, redirect to the OAuth authorize endpoint which will use this form.
            var authorizeUrl = $"https://localhost:7002/connect/authorize" +
                               $"?response_type=code" +
                               $"&client_id={Uri.EscapeDataString(ClientId ?? "passport-webapp")}" +
                               $"&scope=openid profile roles offline_access" +
                               $"&redirect_uri={Uri.EscapeDataString(ReturnUrl ?? "https://localhost:7000/signin-oidc")}" +
                               $"&tenant={Uri.EscapeDataString(_tenantSlug)}" +
                               $"&login_hint={Uri.EscapeDataString(_username)}";

            // Post credentials to Passport.Services via form, then redirect
            // The actual credential validation happens in AuthController which reads the form post
            await JS.InvokeVoidAsync("history.replaceState", null, "", Nav.Uri);
            Nav.NavigateTo(authorizeUrl, forceLoad: true);
        }
        catch (Exception ex)
        {
            _error = "Sign-in failed. Please check your credentials.";
            Console.WriteLine(ex);
        }
        finally
        {
            _isSubmitting = false;
        }
    }
}
